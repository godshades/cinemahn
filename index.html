<!DOCTYPE html>
<html>

<head>
	<meta charset='utf-8' />
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.7.0/fullcalendar.min.css' rel='stylesheet' />
	<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.7.0/fullcalendar.print.css' rel='stylesheet' media='print' />
	<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.7.0/fullcalendar.min.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js'></script>
	<script>
		$(document).ready(function() {
			//Calendar
			var date = new Date();
			var d = date.getDate();
			var m = date.getMonth();
			var y = date.getFullYear();

			$('#calendar').fullCalendar({
				header: {
					left: 'prev,next today',
					center: 'title',
					right: 'month,agendaWeek,agendaDay'
				},
				displayEventTime: false,
				editable: true,
				events: [{
						title: 'CGV tăng 3',
						start: '22:00',
						dow: [1, 2, 3, 4, 5],
						description: '50K sau 22h',
						url: 'https://rapchieuphim.com/khuyen-mai/xem-phim-tang-3-gia-chi-50k-tai-cgv'
					},
					{
						title: 'Beta - Thứ Ba vui vẻ',
						start: '08:30',
						dow: [2],
						description: '45k (2D) và 65k (3D)',
						url: 'https://moveek.com/khuyen-mai/beta-cineplex-thu-ba-vui-ve/'
					},
					{
						title: 'Lotte LOVELY TUESDAY',
						start: '08:30',
						dow: [2],
						description: '45-60k (2D) và 75-90k (3D)',
						url: 'https://lottecinemavn.com/vi-vn/su-kien/lovely-tuesday-(tu-15-09).aspx'
					},
					{
						title: 'Platinum Special Couple\'s Day',
						start: '10:00',
						dow: [2],
						description: 'mua 2 vé tặng 1 bỏng và 2 đồ uống,',
						url: 'https://platinumcineplex.vn/vi/news/news-and-promotion/special-couple-s-day'
					},
					{
						title: 'Platinum Special Thursday',
						start: '10:00',
						dow: [4],
						description: '45K 2D',
						url: 'https://platinumcineplex.vn/vi/news/news-and-promotion/n-a'
					},
					{
						title: 'Platinum ladies\' night',
						start: '10:00',
						dow: [3],
						description: 'giảm 50% cho vé thứ 2 và 1 phiếu giảm 50% cho 1 loại combo tại quầy Concessions cho nữ',
						url: 'https://platinumcineplex.vn/vi/news/news-and-promotion/ladies-night'
					},
				],
				eventClick: function(event) {
					if (event.url) {
						window.open(event.url);
						return false;
					}
				},
				eventRender: function(event, element) {
					element.find('.fc-title').append("<br/>" + event.description);
				}
			});
			// adding a custom events:
			$('#calendar').fullCalendar('addEventSource',
				function(start, end, timezone, callback) {

					var events = [];

					var y = start._d.getFullYear(),
						m = start._d.getMonth();
					var firstDay = new Date(y, m, 1);
					var lastDay = new Date(y, m + 1, 0);

					var test_date = new Date(lastDay);
					while (test_date.getDay() !== 1) {
						test_date.setDate(test_date.getDate() - 1);
					}

					// Last monday of last month
					if (test_date.is().monday()) {
						events.push({
								title: 'CGV CULTURE DAY',
								start: '08:30',
								start: test_date,
								description: '50K 2D',
								url: 'https://www.cgv.vn/default/newsoffer/cgv-culture-day/'
							}, // CGV
							{
								title: 'Lotte Big Smile Day',
								start: '08:30',
								start: test_date,
								description: '45K 2D',
								url: 'https://lottecinemavn.com/vi-vn/su-kien/e-l-selection/big-smile-day-45,000-50,000-%C4%91ong-ve-xem-phim-t.aspx'
							} // lottecinema
						);
					}

					y = end._d.getFullYear(),
						m = end._d.getMonth() - 1;
					firstDay = new Date(y, m, 1);
					lastDay = new Date(y, m + 1, 0);

					test_date = new Date(lastDay);

					while (test_date.getDay() !== 1) {
						test_date.setDate(test_date.getDate() - 1);
					}

					// Last monday of current month
					if (test_date.is().monday()) {
						events.push({
								title: 'CGV CULTURE DAY',
								start: '08:30',
								start: test_date,
								description: '50K 2D',
								url: 'https://www.cgv.vn/default/newsoffer/cgv-culture-day/'
							}, // CGV
							{
								title: 'Lotte Big Smile Day',
								start: '08:30',
								start: test_date,
								description: '45K 2D',
								url: 'https://lottecinemavn.com/vi-vn/su-kien/e-l-selection/big-smile-day-45,000-50,000-%C4%91ong-ve-xem-phim-t.aspx'
							} // lottecinema
						);
					}


					// First wednesday current month
					y = start._d.getFullYear(),
						m = start._d.getMonth();
					firstDay = new Date(y, m, 1);
					lastDay = new Date(y, m + 1, 0);

					test_date = new Date(lastDay);
					while (test_date.getDay() !== 3) {
						test_date.setDate(test_date.getDate() + 1);
					}

					if (test_date.is().wednesday()) {
						events.push({
							title: 'BHD B\'DAY',
							start: '08:30',
							start: test_date,
							description: '45K 2D',
							url: 'http://www.bhdstar.vn/deals/bday-2/'
						});
					}

					// First wednesday next month
					y = end._d.getFullYear(),
						m = end._d.getMonth();
					firstDay = new Date(y, m, 1);
					lastDay = new Date(y, m + 1, 0);

					test_date = new Date(firstDay);
					while (test_date.getDay() !== 3) {
						test_date.setDate(test_date.getDate() + 1);
					}

					if (test_date.is().wednesday()) {
						events.push({
							title: 'BHD B\'DAY',
							start: '08:30',
							start: test_date,
							description: '45K 2D',
							url: 'http://www.bhdstar.vn/deals/bday-2/'
						});
					}

					// First monday current month
					y = start._d.getFullYear(),
						m = start._d.getMonth();
					firstDay = new Date(y, m, 1);
					lastDay = new Date(y, m + 1, 0);

					test_date = new Date(lastDay);
					while (test_date.getDay() !== 1) {
						test_date.setDate(test_date.getDate() + 1);
					}

					if (test_date.is().monday()) {
						events.push({
							title: 'Beta - MAD SALE DAY',
							start: '08:30',
							start: test_date,
							description: '45K 2D & tặng 1 bỏng (Phụ thu 5k đối với phim bom tấn)',
							url: 'https://betacineplex.vn/tin-moi/bung-no-voi-mad-sale-day/118'
						});

					}

					// First monday next month
					y = end._d.getFullYear(),
						m = end._d.getMonth();
					firstDay = new Date(y, m, 1);
					lastDay = new Date(y, m + 1, 0);

					test_date = new Date(firstDay);
					while (test_date.getDay() !== 1) {
						test_date.setDate(test_date.getDate() + 1);
					}

					if (test_date.is().monday()) {
						events.push({
							title: 'Beta - MAD SALE DAY',
							start: '08:30',
							start: test_date,
							description: '45K 2D & tặng 1 bỏng (Phụ thu 5k đối với phim bom tấn)',
							url: 'https://betacineplex.vn/tin-moi/bung-no-voi-mad-sale-day/118'
						});

					}

					// return events generated
					callback(events);
				}
			);
		});
	</script>
	<style>
		html {
			width: 100%;
			height: 100%;
		}

		body {
			--margin: 40px 10px;
			padding: 0;
			font-family: 'Roboto', sans-serif;
			font-size: 14px;
			height: 100%;
		}

		#calendar {
			--margin: 0 auto;
			margin-top: 1%;
		}

		.fc-title {
			white-space: normal;
		}

		#cinema {
			overflow: hidden;
			width: 100%;
			height: 30%;
		}

		#googleMap {
			float: left;
			width: 70%;
			height: 100%;
		}

		#lstcinema {
			width: 30%;
			height: 100%;
			overflow: auto;
		}

		.inline {
			display: inline-block;
		}

		a {
			text-decoration: none;
		}

		#lstcinema a:visited {
			color: blue;
		}

		#currentWeather {
			overflow: hidden;
			float: left;
			width: 40%;
		}

		#timelineWeather {
			overflow: hidden;
			width: 60%;
		}

		#ifram1 {
			border: 0px none;
			height: 260px;
			margin-top: -155px;
			width: -webkit-fill-available;
		}

		#ifram2 {
			border: 0px none;
			height: 393px;
			margin-top: -295px;
			width: -webkit-fill-available;
		}
	</style>
</head>

<body>
	<div id="currentWeather">
		<iframe id="ifram1" scrolling="no" src="about:blank">
		</iframe>
	</div>
	<div id="timelineWeather">
		<iframe id="ifram2" scrolling="no" src="about:blank">
		</iframe>
	</div>
	<div id="cinema">
		<div id="googleMap" class="inline"></div>
		<div id="lstcinema" class="inline">
			<ol id="list"></ol>
		</div>
	</div>
	<div id='calendar'></div>
</body>
<script>
	//Google map
	function initMap() {

		var myLatLng;
		var infowindow = new google.maps.InfoWindow();
		var marker, i, cinema;
		var distance;
		var list, entry, li;
		var distanceArr = [];
		var cinemaArr = [];
		var link;

		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
				myLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude)

				var mapProp = {
					center: myLatLng,
					zoom: 13,
				};
				var map = new google.maps.Map(document.getElementById("googleMap"), mapProp);

				marker = new google.maps.Marker({
					position: myLatLng,
					map: map
				});

				infowindow.setContent('You are here');
				infowindow.open(map, marker);

				link = 'https://darksky.net/forecast/' + position.coords.latitude + ',' + position.coords.longitude + '/si12/en';
				document.getElementById('ifram1').src = link;
				document.getElementById('ifram2').src = link;

				var locations = [
					['CGV Vincom Center Bà Triệu', 21.0110831, 105.847322, 15],
					['CGV Vincom Nguyễn Chí Thanh', 21.0232842, 105.8070238, 15],
					['CGV Aeon Long Biên', 21.0265591, 105.8984919, 15],
					['CGV Hà Nội Centerpoint', 21.0048854, 105.8025138, 15],
					['CGV Mipec Tower', 21.0059122, 105.8211195, 15],
					['CGV Vincom Mega Mall Royal City', 21.0030263, 105.8132952, 15],
					['CGV Vincom Long Biên', 21.0509866, 105.9141536, 15],
					['CGV Artemis Hà Nội', 20.9996882, 105.8261619, 15],
					['CGV Vincom Mega Mall Times City', 20.9986464, 105.8332327, 15],
					['CGV Rice City', 20.9634609, 105.8208142, 15],
					['CGV Hồ Gươm Plaza', 20.9790077, 105.7834491, 15],

					['Lotte Cinema Keangnam', 21.0170462, 105.7814045, 15],
					['Lotte Cinema Hà Đông', 20.990354, 105.782544, 15],
					['Lotte Cinema Thăng Long', 20.990354, 105.782544, 15],

					['Beta Cineplex Thanh Xuân', 21.0026136, 105.8022909, 15],
					['Beta Cineplex Mỹ Đình', 21.0122114, 105.7754499, 15],

					['Platinum Cinema Garden', 21.01535, 105.7757443, 15],
					['BHD Star Vincom', 21.0063122, 105.8316422, 15],
					['Rạp Quốc gia', 21.0167483, 105.8155677, 15],
					['Galaxy Cinema Long Biên', 21.0454409, 105.8660349, 15],
					['Fafim Cinema', 21.0026454, 105.8202419, 15],
					['Rạp Tháng 8', 21.0214854, 105.8503522, 15],
					['Kim Đồng', 21.0238755, 105.8507703, 15],
				];

				for (i = 0; i < locations.length; i++) {
					cinema = new google.maps.LatLng(locations[i][1], locations[i][2]);

					marker = new google.maps.Marker({
						position: cinema,
						map: map
					});

					google.maps.event.addListener(marker, 'click', (function(marker, i) {
						return function() {
							infowindow.setContent(locations[i][0]);
							infowindow.open(map, marker);
						}
					})(marker, i));

					distance = google.maps.geometry.spherical.computeDistanceBetween(myLatLng, cinema)
					//distance = distance / 1000 + 'km'
					distanceArr.push([Math.round(distance) / 1000, locations[i][0], locations[i][1], locations[i][2]])

					cinemaArr.push(cinema);
				}
				distanceArr.sort(function(a, b) {
					return a[0] - b[0]
				});
				var li;

				for (i = 0; i < distanceArr.length; i++) {
					list = document.getElementById('list');
					li = document.createElement("li");
					entry = document.createElement('a');
					entry.setAttribute("href", "#");
					entry.setAttribute("id", "cinema" + i);
					entry.setAttribute("lat", distanceArr[i][2]);
					entry.setAttribute("lng", distanceArr[i][3]);
					entry.appendChild(document.createTextNode('Your location to ' + distanceArr[i][1] + ' : ' + distanceArr[i][0] + ' km'));
					li.appendChild(entry);
					list.appendChild(li);
				}
				// Instantiate a directions service.
				var directionsService = new google.maps.DirectionsService
				var directionDisplay;
				var directionsDisplay = [];

				$('a').click(function(e) {
					cinema = new google.maps.LatLng($(this).attr('lat'), $(this).attr('lng'));

					calculateAndDisplayRoute(map, directionsDisplay, directionsService, directionDisplay, myLatLng, cinema);
				});

			}, function error(msg) {
				alert('Please enable your GPS.');

			}, {
				maximumAge: 600000,
				//timeout: 5000,
				enableHighAccuracy: true
			});
		}


	}

	function calculateAndDisplayRoute(map, directionsDisplay, directionsService, directionDisplay, pointA, pointB) {
		directionsService.route({
			origin: pointA,
			destination: pointB,
			provideRouteAlternatives: true,
			travelMode: google.maps.TravelMode.DRIVING
		}, function(response, status) {
			if (status == google.maps.DirectionsStatus.OK) {
				for (i = 0; i < directionsDisplay.length; i++) {
					directionsDisplay[i].setMap(null);
				}

				for (i = 0; i < response.routes.length; i++) {
					directionDisplay = new google.maps.DirectionsRenderer({
						map: map,
						directions: response,
						routeIndex: i
					})
					directionsDisplay.push(directionDisplay);
				}

			} else {
				window.alert('Directions request failed due to ' + status);
			}
		});
	}
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0MdH3ZvV1t_kmmbMiqEvyeQCFy_mxWTc&callback=initMap&libraries=geometry" type="text/javascript"></script>

</html>
